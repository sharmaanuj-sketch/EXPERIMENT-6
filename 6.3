// account-transfer.js
import express from "express";
import mongoose from "mongoose";
import dotenv from "dotenv";

dotenv.config();
const app = express();
app.use(express.json());

mongoose
  .connect(process.env.MONGO_URI || "mongodb://localhost:27017/accountdb")
  .then(() => console.log("MongoDB connected"))
  .catch((err) => console.log(err));

const accountSchema = new mongoose.Schema({
  accountNumber: { type: String, unique: true, required: true },
  holderName: { type: String, required: true },
  balance: { type: Number, required: true, min: 0 },
});

const Account = mongoose.model("Account", accountSchema);

app.post("/create", async (req, res) => {
  try {
    const { accountNumber, holderName, balance } = req.body;
    const account = new Account({ accountNumber, holderName, balance });
    await account.save();
    res.status(201).json({ message: "Account created successfully", account });
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

app.get("/accounts", async (req, res) => {
  try {
    const accounts = await Account.find();
    res.json(accounts);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.post("/transfer", async (req, res) => {
  const { fromAccount, toAccount, amount } = req.body;

  if (amount <= 0) return res.status(400).json({ error: "Invalid amount" });

  const session = await mongoose.startSession();
  session.startTransaction();
  try {
    const sender = await Account.findOne({ accountNumber: fromAccount }).session(session);
    const receiver = await Account.findOne({ accountNumber: toAccount }).session(session);

    if (!sender || !receiver)
      throw new Error("Invalid account number(s)");

    if (sender.balance < amount)
      throw new Error("Insufficient balance");

    sender.balance -= amount;
    receiver.balance += amount;

    await sender.save({ session });
    await receiver.save({ session });
    await session.commitTransaction();

    res.json({
      message: "Transfer successful",
      from: sender.accountNumber,
      to: receiver.accountNumber,
      amount,
    });
  } catch (err) {
    await session.abortTransaction();
    res.status(400).json({ error: err.message });
  } finally {
    session.endSession();
  }
});

app.get("/", (req, res) => {
  res.send("ðŸ¦ Account Transfer System Running...");
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
